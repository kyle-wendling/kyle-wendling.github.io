<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
    <script src="javascript/giqtest-utils.js"></script>

    <script>
    //jQuery deparam helper, note requires we loaded jquery in context already
(function(h){h.deparam=function(i,j){var d={},k={"true":!0,"false":!1,"null":null};h.each(i.replace(/\+/g," ").split("&"),function(i,l){var m;var a=l.split("="),c=decodeURIComponent(a[0]),g=d,f=0,b=c.split("]["),e=b.length-1;/\[/.test(b[0])&&/\]$/.test(b[e])?(b[e]=b[e].replace(/\]$/,""),b=b.shift().split("[").concat(b),e=b.length-1):e=0;if(2===a.length)if(a=decodeURIComponent(a[1]),j&&(a=a&&!isNaN(a)?+a:"undefined"===a?void 0:void 0!==k[a]?k[a]:a),e)for(;f<=e;f++)c=""===b[f]?g.length:b[f],m=g[c]=
f<e?g[c]||(b[f+1]&&isNaN(b[f+1])?{}:[]):a,g=m;else h.isArray(d[c])?d[c].push(a):d[c]=void 0!==d[c]?[d[c],a]:a;else c&&(d[c]=j?void 0:"")});return d}})(jQuery);

    /** 
     * Firebase
     */
    firebaseInit(firebase);
    firebaseConnect(firebase);

    /**
     * check if in progress
     */
     var testInProgress = false;
    params = jQuery.deparam( window.parent.location.search.replace(/\?/g,'')); //get parent query string
    if(params.length > 0) { //if test is in progress, not new, resume      
       console.log(params);
       inProgress(params["testId"],params["section"]);
    }

    function inProgress(testId, section) { //setup objects and forward to right page
        testInProgress = true;
        //load current state from firebase
        var currentTestRef = firebase.database().ref('test/');
        currentTestRef.orderByChild("testId").equalTo(testId).on("child_added", function(snapshot) { //nonsense just to query by value
          console.log("found test");
            testInst = snapshot.val();
            parent.frames['collect'].testKey = snapshot.key;
            setupTest(parent.frames['collect'],testInst);
            console.log("parent.frames['collect'].picSectionCollector",parent.frames['collect'].picSectionCollector);
            //forward to start of section
            var sections = { ps: "pictureSectionInstructions.html",
                                vs: "vocabularySectionInstructions.html",
                                rs: "recallSectionInstructions.html",
                                rbs: "recallBackwardsSectionInstructions.html",
                                res: "relationshipSectionInstructions.html",
                                as: "arithmeticSectionInstructions.html"
                            }
            window.location = sections[section];
        }, function (errorObject) {
          console.log("failed to find test with ID: ",testId," error ",errorObject.code);
        });
    }

    var writeIsFinished = false;
    /**
     * create New Test
     */
    function createNewTest(testId, username, email, date) {
        console.log("createNewTest");

        return firebase.database().ref('test').push({
            testId: testId,
            email: email,
            username: username,
            startDate: date
        }, function(error) {
            if (error) {
                console.log('firebase: Error ', error)
            } else {
                writeIsFinished = true;
                console.log("firebase: Data saved successfully");
            }
        }).key;
    }
    /**
     * update Test
     */
    function updateTest(testKey, username, email) {
        firebase.database().ref('/test/' + testKey + "/email").set(email);
        firebase.database().ref('/test/' + testKey + "/username").set(username);
    }

    function submitForm() {
        nextPage = 'userInfo.html';
        document.actionForm.action = nextPage;
        //update user settings
        if (firebase) { //wait for async finish of write
            if (!writeIsFinished) {
                //try {
                setTimeout(function() {submitForm();}, 500); // wait a bit for db commit and try again
            } else {
                //write is done, allow submit
                document.actionForm.submit();
            }
        } else { //no firebase so ust proceed
            document.actionForm.submit();
        }
        return false;
    }

    function doTimeout() {
        return;
    }
    </script>
    <script type="text/javascript" language="JavaScript">
    isEmail = new Array();
    isRequired = new Array();
    isSelect = new Array();
    isNum = new Array();
    isRadio = new Array();
    isRadio[0] = new Array("QUESTION[1]", "actionForm", "Please select an answer.");

    function customValidate() {
        return true;
    }

    function storeSetup() {
        testKey = createNewTest(testId, 'blank', 'blank', new Date().toString());
        parent.frames['collect'].testKey = testKey;
    }

    if(!testInProgress) { //if this is a new test
        var d = Date.now();
        var testId = d.toString() + (Math.floor(Math.random() * 90) + 10).toString(); //date + 2 random digits
        var testKey = '';
        console.log("firebase", firebase);
        if (firebase) {
            storeSetup();
        }
        parent.frames['collect'].testId = testId;
    }
    </script>
    <script src="javascript/validate.js" language="JavaScript"></script>
    <title>Take Test</title>
    <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
    <link href="css/test.css" rel="stylesheet" type="text/css">
</head>

<body leftmargin="0" topmargin="0" onload="javascript:return doTimeout();" alink="#000000" link="#000000" text="#000000" vlink="#000000">
    <script>
    if(!parent.frames['collect'].testmode) {
(function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-237477-1', 'auto');
    ga('send', 'pageview');
}
    </script>
  <script>
    if(parent.frames['collect'].testmode) { 
        document.write("<h1>TEST MODE</h1>");
      }
  </script>    
    <table align="left" border="0" cellpadding="0" cellspacing="0" width="100%">
        <tbody>
            <tr>
                <td>
                    <table border="0" cellpadding="0" cellspacing="0" width="100%">
                        <tbody>
                            <tr class="menubackground">
                                <td class="HT" background="images/bar.gif" bgcolor="#ffffff" width="400">
                                    <div align="left"><strong><img src="images/lefter.gif" height="29" width="8"><span class="T">GIQTest
              Instructions </span><img src="images/righter.gif" height="29" width="8"></strong></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <br/>
    <br/>
    <form action="" method="post" name="actionForm">
        <table class="menutextbold" border="0" width="100%">
            <tbody>
                <tr>
                    <td width="10">&nbsp;</td>
                    <td>
                        <table align="left" border="0">
                            <!-- the body row -->
                            <tbody>
                                <tr>
                                    <td class="whiteBackground">
                                        <table bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" width="600">
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <div align="right"><span class="largetextHighlight"><img src="images/lefter.gif" height="29" width="8"></span></div>
                                                    </td>
                                                    <td class="HT" background="images/bar.gif">
                                                        <div class="HT" align="center">
                                                            <strong>Instructions</strong>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div align="left"><span class="largetextHighlight"><img src="images/righter.gif" height="29" width="8"></span></div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td background="images/leftedge.gif">
                                                        <div align="right"></div>
                                                    </td>
                                                    <td class="RT">
                                                        <ul>
                                                            <li><span class="menutextLarge">One question is presented
                          at a time. After answering the question click the 'Next'
                        button.</span></li>
                                                            <li><span class="menutextLarge"> Each Section begins with
                        instructions and an example question.</span></li>
                                                            <li><span class="menutextLarge">Do not use any outside materials
                          such as a pen or paper, a dictionary, or other web sites.
                        Be sure there are no external distractions.</span></li>
                                                            <li><span class="menutextLarge"> Do not click the 'reload',
                        'forward', 'back' buttons during the Test.</span></li>
                                                            <li><span class="menutextLarge">The first page asks for
                          some user information, this information is not used to
                        score the test.</span></li>
                                                            <li>This test is meant for adults over 18, minors' full scale scores may not be accurate.</li>
                                                            <li><span class="menutextLarge">Click 'Start' to begin.
                          You will be taken to the instructions for the first section.
                        Good luck. </span></li>
                                                        </ul>
                                                    </td>
                                                    <td background="images/rightedge.gif">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div align="right"><img src="images/leftb.gif" height="8" width="8"></div>
                                                    </td>
                                                    <td background="images/barbottom.gif"><img src="images/barbottom.gif" height="8" width="8"></td>
                                                    <td><img src="images/rightb.gif" height="8" width="8"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
    <table class="menutextbold" border="0" width="100%">
        <tbody>
            <tr>
                <td width="10">&nbsp;</td>
                <td>
                    <table align="left" border="0">
                        <!-- the body row -->
                        <tbody>
                            <tr>
                                <td class="whiteBackground">
                                    <table bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" width="600">
                                        <tbody>
                                            <tr>
                                                <td width="5">
                                                    <div align="right"><span class="largetextHighlight"><img src="images/lefter.gif" height="29" width="8"></span></div>
                                                </td>
                                                <td class="HT" background="images/bar.gif"> <span class="RT">This
                        is your <strong>Test ID</strong></span> <strong><span id="test_id"></span></strong>.
                                                    <strong> Save</strong><span class="RT"> this number, it can
                        be used later to resume this test. </span>
                                                    <div align="right"> </div>
                                                </td>
                                                <td width="5">
                                                    <div align="left"><span class="largetextHighlight"><img src="images/righter.gif" height="29" width="8"></span></div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div align="right"><img src="images/leftb.gif" height="8" width="8"></div>
                                                </td>
                                                <td background="images/barbottom.gif"><img src="images/barbottom.gif" height="8" width="8"></td>
                                                <td><img src="images/rightb.gif" height="8" width="8"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="menutextbold" border="0" width="100%">
        <tbody>
            <tr>
                <td width="10">&nbsp;</td>
                <td>
                    <table align="left" border="0">
                        <!-- the body row -->
                        <tbody>
                            <tr>
                                <td class="whiteBackground">
                                    <table bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" width="600">
                                        <tbody>
                                            <tr>
                                                <td width="5">
                                                    <div align="right"><span class="largetextHighlight"><img src="images/lefter.gif" height="29" width="8"></span></div>
                                                </td>
                                                <td class="HT" background="images/bar.gif"> <strong>Click 'start'
                        to begin the test.</strong> </td>
                                                <td class="HT" background="images/bar.gif">
                                                    <div align="right">
                                                        <input onclick="javascript:this.disabled=true; submitForm();" value="Start &gt;&gt;" class="SubT" name="next2" type="submit">
                                                    </div>
                                                </td>
                                                <td width="5">
                                                    <div align="left"><span class="largetextHighlight"><img src="images/righter.gif" height="29" width="8"></span></div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div align="right"><img src="images/leftb.gif" height="8" width="8"></div>
                                                </td>
                                                <td colspan="2" background="images/barbottom.gif"><img src="images/barbottom.gif" height="8" width="8"></td>
                                                <td><img src="images/rightb.gif" height="8" width="8"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
</body>
<script>
document.getElementById("test_id").textContent = testId;
</script>

</html>
