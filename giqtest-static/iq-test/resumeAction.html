<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
<script src="javascript/giqtest-utils.js"></script>

<script>
    //jQuery deparam helper, note requires we loaded jquery in context already
(function(h){h.deparam=function(i,j){var d={},k={"true":!0,"false":!1,"null":null};h.each(i.replace(/\+/g," ").split("&"),function(i,l){var m;var a=l.split("="),c=decodeURIComponent(a[0]),g=d,f=0,b=c.split("]["),e=b.length-1;/\[/.test(b[0])&&/\]$/.test(b[e])?(b[e]=b[e].replace(/\]$/,""),b=b.shift().split("[").concat(b),e=b.length-1):e=0;if(2===a.length)if(a=decodeURIComponent(a[1]),j&&(a=a&&!isNaN(a)?+a:"undefined"===a?void 0:void 0!==k[a]?k[a]:a),e)for(;f<=e;f++)c=""===b[f]?g.length:b[f],m=g[c]=
f<e?g[c]||(b[f+1]&&isNaN(b[f+1])?{}:[]):a,g=m;else h.isArray(d[c])?d[c].push(a):d[c]=void 0!==d[c]?[d[c],a]:a;else c&&(d[c]=j?void 0:"")});return d}})(jQuery);
/** 
 * Firebase
 */
firebaseInit(firebase);
firebaseConnect(firebase);

var queryStr = jQuery.deparam(window.location.search.replace(/\?/g,''));
console.log("queryStr ",queryStr);
if(!queryStr["testId"]) console.log("error no test ID");
var testIdLookup = queryStr["testId"].trim();

var testInst = '';//test to lookup
var paypalDate = '';

var currentTestRef = firebase.database().ref('test/');
currentTestRef.orderByChild('testId').equalTo(testIdLookup).on("value", function(snapshot) { //nonsense just to query by value
	console.log("found snapshot from ID ", testIdLookup, snapshot.val());
	if(snapshot.val() != null) {
		snapshot.forEach(function(test) {//using value the snapshot is a collection for some reason
		  	console.log("found test", test.key, test.val());
			testInst = test.val();
			testKey = test.key;
			answers = testInst["answers"];
			paypalDate = testInst["paypalDate"];
			forwardTo();
		}) 
	} else {
		console.log("snapshot was null, no test found");
		window.location.href = "../resume.html";//forward back to resume page, no test found
	}

	//console.log("firebase answers",answers);
}, function (errorObject) {
  console.log("failed to find test with ID: ",testId," error ",errorObject.code);
});

function forwardTo() {
	if(!paypalDate) {
		//no payment made yet, forward to correct section or to preReport
		//check answers in arith, last section
		console.log("no paypal info for testId", testIdLookup);
		console.log("answers ",answers);

		if(!answers["ps"].length || answers["ps"].length < 15) resumeInProgress({section: "ps"});
		if(!answers["vs"].length || answers["vs"].length < 17) resumeInProgress({section: "vs"});
		if(!answers["rs"].length || answers["rs"].length < 6) resumeInProgress({section: "rs"});
		if(!answers["rbs"].length || answers["rbs"].length < 5) resumeInProgress({section: "rbs"});
		if(!answers["res"].length || answers["ps"].length < 10) resumeInProgress({section: "res"});
		if(!answers["as"].length || answers["as"].length < 10) resumeInProgress({section: "as"});

		//test must be complete, send to payment page
		window.location = "preReport.html" + "?" + "testId="+testIdLookup + "&testKey="+testKey;

	} else {
		//test already paid for
		console.log(" paypal paid, date info ", paypalDate);
		//forward to test report, test complete and paid for
		window.location = "finalReport.html" + "?" + "testId="+testIdLookup;
	}
}
function preReport(section) { //test complete but not paid for
	window.location = "index.html" + "?" + "testId="+testIdLookup+"&"+"section="+section["section"];
}

function resumeInProgress(section) {
	var openTest = "testId="+testIdLookup+"&"+"section="+section["section"];
	console.log("openTest ",openTest);
	window.location = "index.html" + "?" + openTest;
}

</script>
<title>Resume a test</title><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link href="css/test.css" rel="stylesheet" type="text/css"></head>
<body leftmargin="0" topmargin="0" onload="">
	<script>
	  if(!parent.frames['collect'].testmode) {
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	  ga('create', 'UA-237477-1', 'auto');
	  ga('send', 'pageview');
}
	</script>
	
</body>
</html>